#!/bin/bash
# ============================================================
# 武将会議システム v2 - Claude Code CLI版
#
# 使い方:
#   ./samurai_council.sh "解決したい課題"
#
# 例:
#   ./samurai_council.sh "新サービスの技術スタック選定"
#   ./samurai_council.sh "チームの生産性を上げつつ残業を減らしたい"
#
# 必要: claude CLI (Claude Code / Claude Pro)
# ============================================================

set -euo pipefail

PROBLEM="${1:?使い方: ./samurai_council.sh \"解決したい課題\"}"
MODEL="sonnet"
TMPDIR=$(mktemp -d)
trap 'rm -rf "$TMPDIR"' EXIT

# --- ユーティリティ ---
speak() {
  # リアルタイム表示しつつファイルにも保存
  local label="$1" file="$2"
  echo ""
  echo "$label"
  echo "---"
  tee "$file"
  echo ""
  echo "---"
}

# ============================================================
echo ""
echo "🏯🏯🏯  武 将 会 議  🏯🏯🏯"
echo ""
echo "【議題】$PROBLEM"
echo ""

# === 第一幕: 大将の分析 ===
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "📢 第一幕: 大将が議題を分析"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

claude -p \
  --model "$MODEL" \
  --system-prompt '汝は大将「信玄」。武将口調（「〜じゃ」「〜せよ」）で話す。
汝の役割は【大局と具体を行き来する】ことじゃ。
常に「これを成せば何が実現できるか？」という大局の問いと、「そのために今何をすべきか？」という具体を往復せよ。
議論が元の目的からそれた場合は遠慮なく反論し、軌道修正せよ。' \
  "以下の議題を分析せよ。
1. この議題の本質（大局: これを解決すると何が実現できるか）
2. 具体的に検討すべき論点を3つ
3. 足軽どもへの問い（各自の観点で考えさせる問い）

各項目2行以内で簡潔に。

【議題】$PROBLEM" \
  | speak "🏯 大将・信玄:" "$TMPDIR/analysis.txt"

# === 第二幕: 足軽の初回意見 ===
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "📢 第二幕: 足軽ども、意見を申せ！"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

ANALYSIS=$(cat "$TMPDIR/analysis.txt")

# 太郎（慎重派）
claude -p \
  --model "$MODEL" \
  --system-prompt '汝は足軽「太郎」。「〜でござる」と慎重に話す。
石橋を叩いて渡る性格。リスク・安全性・保守性を重視。
最悪のケースを常に想定し、地に足のついた意見を述べよ。
ただし慎重すぎて的外れなことも時々言う。' \
  "大将の分析を踏まえ、慎重な観点から意見を4行以内で述べよ。

【議題】$PROBLEM
【大将の分析】$ANALYSIS" \
  | speak "⚔️  太郎（慎重派）:" "$TMPDIR/taro1.txt"

# 次郎（大胆派）
claude -p \
  --model "$MODEL" \
  --system-prompt '汝は足軽「次郎」。「〜でござるよ！」と威勢よく話す。
大胆不敵で挑戦好き。革新性・チャンス・スピードを重視。
既存の枠を壊す発想を得意とするが、時にリスクを軽視しがち。' \
  "大将の分析を踏まえ、大胆な観点から意見を4行以内で述べよ。

【議題】$PROBLEM
【大将の分析】$ANALYSIS" \
  | speak "⚔️  次郎（大胆派）:" "$TMPDIR/jiro1.txt"

# 三郎（実務派）
claude -p \
  --model "$MODEL" \
  --system-prompt '汝は足軽「三郎」。「〜でありますよ」と淡々と話す。
現場叩き上げの実務家。理想論より「で、具体的にどうやるの？」を突き詰める。
工数・手順・現場の制約を常に考え、地味だが核心を突く意見を出す。
時に理想を軽視しすぎることもある。' \
  "大将の分析を踏まえ、実務的な観点から意見を4行以内で述べよ。

【議題】$PROBLEM
【大将の分析】$ANALYSIS" \
  | speak "⚔️  三郎（実務派）:" "$TMPDIR/saburo1.txt"

# === 第三幕: 反論ラウンド ===
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "📢 第三幕: 反論・議論！"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

TARO1=$(cat "$TMPDIR/taro1.txt")
JIRO1=$(cat "$TMPDIR/jiro1.txt")
SABURO1=$(cat "$TMPDIR/saburo1.txt")

# 太郎が反論
claude -p \
  --model "$MODEL" \
  --system-prompt '汝は足軽「太郎」。慎重派。「〜でござる」と話す。
他の者の意見の穴やリスクを指摘しつつ、良い点は素直に認めよ。3行以内。' \
  "次郎と三郎の意見に対して反論・補足せよ。

【議題】$PROBLEM
【次郎の意見】$JIRO1
【三郎の意見】$SABURO1" \
  | speak "⚔️  太郎 → 次郎・三郎へ反論:" "$TMPDIR/taro2.txt"

# 次郎が反論
claude -p \
  --model "$MODEL" \
  --system-prompt '汝は足軽「次郎」。大胆派。「〜でござるよ！」と威勢よく話す。
守りに入りすぎた意見には果敢に反論し、可能性を主張せよ。良い点は認めよ。3行以内。' \
  "太郎と三郎の意見に対して反論・補足せよ。

【議題】$PROBLEM
【太郎の意見】$TARO1
【三郎の意見】$SABURO1" \
  | speak "⚔️  次郎 → 太郎・三郎へ反論:" "$TMPDIR/jiro2.txt"

# 三郎が反論
claude -p \
  --model "$MODEL" \
  --system-prompt '汝は足軽「三郎」。実務派。「〜でありますよ」と淡々と話す。
理想論や極端な意見には「で、現場でどうするの？」と問い返せ。良い点は認めよ。3行以内。' \
  "太郎と次郎の意見に対して反論・補足せよ。

【議題】$PROBLEM
【太郎の意見】$TARO1
【次郎の意見】$JIRO1" \
  | speak "⚔️  三郎 → 太郎・次郎へ反論:" "$TMPDIR/saburo2.txt"

# === 最終幕: 大将の結論 ===
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "📢 最終幕: 大将の裁定"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

TARO2=$(cat "$TMPDIR/taro2.txt")
JIRO2=$(cat "$TMPDIR/jiro2.txt")
SABURO2=$(cat "$TMPDIR/saburo2.txt")

claude -p \
  --model "$MODEL" \
  --system-prompt '汝は大将「信玄」。武将口調で話す。
【大局と具体を行き来する】のが汝の真骨頂じゃ。
結論では必ず以下を述べよ:
・大局: これを成すことで何が実現できるか
・具体: そのために今すぐ取るべき行動
・各足軽の意見で取り入れる点と却下する点
目的からそれた意見があれば明確に却下せよ。' \
  "足軽どもの議論を踏まえ、最終結論を8行以内で述べよ。

【議題】$PROBLEM

【初回意見】
太郎（慎重派）: $TARO1
次郎（大胆派）: $JIRO1
三郎（実務派）: $SABURO1

【反論ラウンド】
太郎の反論: $TARO2
次郎の反論: $JIRO2
三郎の反論: $SABURO2" \
  | speak "🏯 大将・信玄【最終裁定】:" "$TMPDIR/conclusion.txt"

echo "🏯🏯🏯  会 議 終 了  🏯🏯🏯"
echo ""
