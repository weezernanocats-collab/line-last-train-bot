# 株式ポートフォリオ管理スプレッドシート

## 概要

Google スプレッドシートで株式ポートフォリオを管理するためのGoogle Apps Script（GAS）です。

## 機能

- 証券コード入力で銘柄情報を自動取得
- 現在値の自動取得（Google Finance経由）
- EPS/BPS/PER/PBRの自動取得（みんかぶ経由）
- 理論株価の自動計算（PER基準・PBR基準）
- 買いシグナルの自動判定
- 損益の自動計算

## セットアップ手順

### 1. 新規スプレッドシートを作成

1. Google ドライブで「新規」→「Google スプレッドシート」
2. 適当な名前を付ける（例：「株式ポートフォリオ」）

### 2. スクリプトをコピー

1. メニューから「拡張機能」→「Apps Script」を開く
2. エディタが開いたら、既存のコード（`function myFunction() {}`）を全て削除
3. `StockPortfolio.gs` の内容を全てコピー＆ペースト
4. 「保存」ボタン（💾）をクリック
5. スクリプトエディタを閉じる

### 3. シートを初期化

1. スプレッドシートを再読み込み（F5またはブラウザ更新）
2. メニューバーに「株式管理」が追加される（数秒かかる場合があります）
3. 「株式管理」→「初期化（シート作成）」をクリック
4. 初回実行時は認証が求められます：
   - 「権限を確認」をクリック
   - Googleアカウントを選択
   - 「詳細」→「[プロジェクト名]（安全ではないページ）に移動」
   - 「許可」をクリック

## シート構成

### ポートフォリオ（メインシート）

| 列 | 項目 | 入力方法 |
|---|---|---|
| A | コード | 手動入力（4桁の証券コード） |
| B | 種別 | 自動（銘柄マスターから取得） |
| C | 銘柄 | 自動（銘柄マスターから取得） |
| D | 数量 | 手動入力 |
| E | 取得単価 | 手動入力 |
| F | 買い | 自動（理論株価 > 現在値 で「○」） |
| G | 理論株価(PER) | 自動計算（適正PER × EPS） |
| H | 理論株価(PBR) | 自動計算（適正PBR × BPS） |
| I | PER予想 | 手動入力（アナリスト予想） |
| J | PBR予想 | 手動入力（アナリスト予想） |
| K | 現在値 | 自動取得 |
| L | 取得額 | 自動計算（取得単価 × 数量） |
| M | 評価額 | 自動計算（現在値 × 数量） |
| N | 損益(円) | 自動計算（評価額 - 取得額） |
| O | 損益(%) | 自動計算（損益(円) / 取得額） |

### 銘柄マスター

保有銘柄の基本情報を登録するシートです。

| 列 | 項目 |
|---|---|
| A | コード |
| B | 種別（業種） |
| C | 銘柄名 |

サンプルデータが入っていますので、ご自身の保有銘柄に書き換えてください。

### 設定

業種別の適正PER/PBRを設定するシートです。

| 列 | 項目 |
|---|---|
| A | 種別 |
| B | 適正PER |
| C | 適正PBR |
| D | 備考 |

理論株価の計算に使用されます。業種に合わせて調整してください。

## 使い方

### 銘柄を追加

1. 「銘柄マスター」シートに銘柄情報を追加
   - コード：4桁の証券コード
   - 種別：業種（設定シートの種別と合わせる）
   - 銘柄名：会社名

2. 「ポートフォリオ」シートでA列にコードを入力
   - 種別と銘柄名が自動で表示されます

3. 数量と取得単価を入力
   - その他の項目は自動計算されます

### データを更新

- メニュー「株式管理」→「全データ更新」
- キャッシュをクリアして最新データを取得します

### サマリーを確認

- メニュー「株式管理」→「サマリー表示」
- 総取得額、総評価額、総損益を確認できます

## 理論株価の計算式

### PER基準

```
理論株価 = 適正PER × EPS（1株当たり利益）
```

- 適正PER：設定シートで業種別に設定
- EPS：みんかぶから自動取得

### PBR基準

```
理論株価 = 適正PBR × BPS（1株当たり純資産）
```

- 適正PBR：設定シートで業種別に設定
- BPS：みんかぶから自動取得

## 買いシグナル

「買い」列に「○」が表示される条件：
- 理論株価（PER基準）が現在値より高い、または
- 理論株価（PBR基準）が現在値より高い

両方またはどちらかが現在値を上回っていれば、割安と判断して「○」が表示されます。

## アナリスト予想について

PER予想・PBR予想は自動取得が困難なため、手動入力となっています。

確認できるソース：
- マネックス証券「銘柄スカウター」
- Yahoo!ファイナンス（一部銘柄）
- 各証券会社のアナリストレポート

## データソースについて

| データ | 取得元 | 備考 |
|---|---|---|
| 現在値 | Google Finance | 許可されている |
| EPS/BPS/PER/PBR | みんかぶ | グレーゾーン |

**注意**：
- 株探は2025年よりスクレイピングが公式に禁止されています
- みんかぶは明示的な禁止はありませんが、過度なアクセスは控えてください
- キャッシュ機能（1時間）で負荷を軽減しています

## トラブルシューティング

### 「N/A」や「Error」が表示される

- 証券コードが正しいか確認
- インターネット接続を確認
- 「全データ更新」を実行

### メニューが表示されない

- ページを再読み込み（F5）
- 少し待ってから再確認

### 認証エラーが出る

- Apps Scriptの認証を再度行う
- 「拡張機能」→「Apps Script」→「実行」→「onOpen」を手動実行

## カスタム関数

スプレッドシートのセルで直接使用できます：

```
=STOCK_PRICE("7203")    // 株価取得
=STOCK_EPS("7203")      // EPS取得
=STOCK_BPS("7203")      // BPS取得
=STOCK_PER("7203")      // PER取得
=STOCK_PBR("7203")      // PBR取得
```

## 制限事項

- GOOGLEFINANCE関数は日本株に非対応
- データ更新は1時間に1回（キャッシュ）
- アナリスト予想は手動入力
- リアルタイム株価ではありません（15〜20分遅延の場合あり）

## ライセンス

個人利用のみ。商用利用は禁止です。
